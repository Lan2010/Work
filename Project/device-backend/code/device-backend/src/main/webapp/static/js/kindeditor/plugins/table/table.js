KindEditor.plugin("table",function($){var q=this,i="table",r=q.lang(i+"."),H="ke-zeroborder";function d(e,l){l=l.toUpperCase(),e.css("background-color",l),e.css("color","#000000"===l?"#FFFFFF":"#000000"),e.html(l)}var c=[];function W(n,e){function a(){$.each(c,function(){this.remove()}),c=[],$(document).unbind("click,mousedown",a),n.unbind("click,mousedown",a)}e.bind("click,mousedown",function(e){e.stopPropagation()}),e.click(function(e){a();var l=$(this),t=l.pos(),o=$.colorpicker({x:t.x,y:t.y+l.height(),z:811214,selectedColor:$(this).html(),colors:q.colorTable,noColor:q.lang("noColor"),shadowMode:q.shadowMode,click:function(e){d(l,e),a()}});c.push(o),$(document).bind("click,mousedown",a),n.bind("click,mousedown",a)})}function s(e,l,t){for(var o=0,n=0,a=l.cells.length;n<a&&l.cells[n]!=t;n++)o+=l.cells[n].rowSpan-1;return t.cellIndex-o}q.plugin.table={prop:function(e){var b,l=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+r.cells+"</label>",r.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',r.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+r.size+"</label>",r.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select> &nbsp; ",r.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+r.space+"</label>",r.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',r.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+r.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+r.alignDefault+"</option>",'<option value="left">'+r.alignLeft+"</option>",'<option value="center">'+r.alignCenter+"</option>",'<option value="right">'+r.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+r.border+"</label>",r.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',r.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+r.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),k=q.cmd.range.createBookmark(),t=q.createDialog({name:i,width:500,title:q.lang(i),body:l,beforeRemove:function(){R.unbind()},yesBtn:{name:q.lang("yes"),click:function(e){var l=w.val(),t=f.val(),o=x.val(),n=S.val(),a=y.val(),i=C.val(),r=B.val(),d=T.val(),c=A.val(),s=I.val(),p=$(R[0]).html()||"",g=$(R[1]).html()||"";if(0==l||!/^\d+$/.test(l))return alert(q.lang("invalidRows")),void w[0].focus();if(0==t||!/^\d+$/.test(t))return alert(q.lang("invalidRows")),void f[0].focus();if(!/^\d*$/.test(o))return alert(q.lang("invalidWidth")),void x[0].focus();if(!/^\d*$/.test(n))return alert(q.lang("invalidHeight")),void S[0].focus();if(!/^\d*$/.test(r))return alert(q.lang("invalidPadding")),void B[0].focus();if(!/^\d*$/.test(d))return alert(q.lang("invalidSpacing")),void T[0].focus();if(!/^\d*$/.test(s))return alert(q.lang("invalidBorder")),void I[0].focus();if(b)return""!==o?b.width(o+a):b.css("width",""),void 0!==b[0].width&&b.removeAttr("width"),""!==n?b.height(n+i):b.css("height",""),void 0!==b[0].height&&b.removeAttr("height"),b.css("background-color",g),void 0!==b[0].bgColor&&b.removeAttr("bgColor"),""!==r?b[0].cellPadding=r:b.removeAttr("cellPadding"),""!==d?b[0].cellSpacing=d:b.removeAttr("cellSpacing"),""!==c?b[0].align=c:b.removeAttr("align"),""!==s?b.attr("border",s):b.removeAttr("border"),""===s||"0"===s?b.addClass(H):b.removeClass(H),""!==p?b.attr("borderColor",p):b.removeAttr("borderColor"),q.hideDialog().focus(),q.cmd.range.moveToBookmark(k),q.cmd.select(),void q.addBookmark();var v="";""!==o&&(v+="width:"+o+a+";"),""!==n&&(v+="height:"+n+i+";"),""!==g&&(v+="background-color:"+g+";");var u="<table";""!==v&&(u+=' style="'+v+'"'),""!==r&&(u+=' cellpadding="'+r+'"'),""!==d&&(u+=' cellspacing="'+d+'"'),""!==c&&(u+=' align="'+c+'"'),""!==s&&(u+=' border="'+s+'"'),""!==s&&"0"!==s||(u+=' class="'+H+'"'),""!==p&&(u+=' bordercolor="'+p+'"'),u+=">";for(var m=0;m<l;m++){u+="<tr>";for(var h=0;h<t;h++)u+="<td>"+($.IE?"&nbsp;":"<br />")+"</td>";u+="</tr>"}u+="</table>",$.IE||(u+="<br />"),q.insertHtml(u),q.select().hideDialog().focus(),q.addBookmark()}}}).div,w=$('[name="rows"]',t).val(3),f=$('[name="cols"]',t).val(2),x=$('[name="width"]',t).val(100),S=$('[name="height"]',t),y=$('[name="widthType"]',t),C=$('[name="heightType"]',t),B=$('[name="padding"]',t).val(2),T=$('[name="spacing"]',t).val(0),A=$('[name="align"]',t),I=$('[name="border"]',t).val(1),R=$(".ke-input-color",t);if(W(t,R.eq(0)),W(t,R.eq(1)),d(R.eq(0),"#000000"),d(R.eq(1),""),w[0].focus(),w[0].select(),!e&&(b=q.plugin.getSelectedTable())){w.val(b[0].rows.length),f.val(0<b[0].rows.length?b[0].rows[0].cells.length:0),w.attr("disabled",!0),f.attr("disabled",!0);var o,n=b[0].style.width||b[0].width,a=b[0].style.height||b[0].height;void 0!==n&&(o=/^(\d+)((?:px|%)*)$/.exec(n))?(x.val(o[1]),y.val(o[2])):x.val(""),void 0!==a&&(o=/^(\d+)((?:px|%)*)$/.exec(a))&&(S.val(o[1]),C.val(o[2])),B.val(b[0].cellPadding||""),T.val(b[0].cellSpacing||""),A.val(b[0].align||""),I.val(void 0===b[0].border?"":b[0].border),d(R.eq(0),$.toHex(b.attr("borderColor")||"")),d(R.eq(1),$.toHex(b[0].style.backgroundColor||b[0].bgColor||"")),x[0].focus(),x[0].select()}},cellprop:function(){var e=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+r.size+"</label>",r.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select> &nbsp; ",r.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+r.percent+"</option>",'<option value="px">'+r.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+r.align+"</label>",r.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+r.alignDefault+"</option>",'<option value="left">'+r.alignLeft+"</option>",'<option value="center">'+r.alignCenter+"</option>",'<option value="right">'+r.alignRight+"</option>","</select> ",r.verticalAlign+' <select name="verticalAlign">','<option value="">'+r.alignDefault+"</option>",'<option value="top">'+r.alignTop+"</option>",'<option value="middle">'+r.alignMiddle+"</option>",'<option value="bottom">'+r.alignBottom+"</option>",'<option value="baseline">'+r.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+r.border+"</label>",r.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',r.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+r.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),s=q.cmd.range.createBookmark(),l=q.createDialog({name:i,width:500,title:q.lang("tablecell"),body:e,beforeRemove:function(){f.unbind()},yesBtn:{name:q.lang("yes"),click:function(e){var l=p.val(),t=g.val(),o=v.val(),n=u.val(),a=(m.val(),h.val(),b.val()),i=k.val(),r=w.val(),d=$(f[0]).html()||"",c=$(f[1]).html()||"";return/^\d*$/.test(l)?/^\d*$/.test(t)?/^\d*$/.test(r)?(x.css({width:""!==l?l+o:"",height:""!==t?t+n:"","background-color":c,"text-align":a,"vertical-align":i,"border-width":r,"border-style":""!==r?"solid":"","border-color":d}),q.hideDialog().focus(),q.cmd.range.moveToBookmark(s),q.cmd.select(),void q.addBookmark()):(alert(q.lang("invalidBorder")),void w[0].focus()):(alert(q.lang("invalidHeight")),void g[0].focus()):(alert(q.lang("invalidWidth")),void p[0].focus())}}}).div,p=$('[name="width"]',l).val(100),g=$('[name="height"]',l),v=$('[name="widthType"]',l),u=$('[name="heightType"]',l),m=$('[name="padding"]',l).val(2),h=$('[name="spacing"]',l).val(0),b=$('[name="textAlign"]',l),k=$('[name="verticalAlign"]',l),w=$('[name="border"]',l).val(1),f=$(".ke-input-color",l);W(l,f.eq(0)),W(l,f.eq(1)),d(f.eq(0),"#000000"),d(f.eq(1),""),p[0].focus(),p[0].select();var t,x=q.plugin.getSelectedCell(),o=x[0].style.width||x[0].width||"",n=x[0].style.height||x[0].height||"";(t=/^(\d+)((?:px|%)*)$/.exec(o))?(p.val(t[1]),v.val(t[2])):p.val(""),(t=/^(\d+)((?:px|%)*)$/.exec(n))&&(g.val(t[1]),u.val(t[2])),b.val(x[0].style.textAlign||""),k.val(x[0].style.verticalAlign||"");var a=x[0].style.borderWidth||"";a&&(a=parseInt(a)),w.val(a),d(f.eq(0),$.toHex(x[0].style.borderColor||"")),d(f.eq(1),$.toHex(x[0].style.backgroundColor||"")),p[0].focus(),p[0].select()},insert:function(){this.prop(!0)},delete:function(){var e=q.plugin.getSelectedTable();q.cmd.range.setStartBefore(e[0]).collapse(!0),q.cmd.select(),e.remove(),q.addBookmark()},colinsert:function(e){var l=q.plugin.getSelectedTable()[0],t=q.plugin.getSelectedRow()[0],o=q.plugin.getSelectedCell()[0],n=o.cellIndex+e;n+=l.rows[0].cells.length-t.cells.length;for(var a=0,i=l.rows.length;a<i;a++){var r=l.rows[a],d=r.insertCell(n);d.innerHTML=$.IE?"":"<br />",n=s(0,r,d)}q.cmd.range.selectNodeContents(o).collapse(!0),q.cmd.select(),q.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(e){var l=q.plugin.getSelectedTable()[0],t=q.plugin.getSelectedRow()[0],o=q.plugin.getSelectedCell()[0],n=t.rowIndex;1===e&&(n=t.rowIndex+(o.rowSpan-1)+e);for(var a=l.insertRow(n),i=0,r=t.cells.length;i<r;i++){1<t.cells[i].rowSpan&&(r-=t.cells[i].rowSpan-1);var d=a.insertCell(i);1===e&&1<t.cells[i].colSpan&&(d.colSpan=t.cells[i].colSpan),d.innerHTML=$.IE?"":"<br />"}for(var c=n;0<=c;c--){var s=l.rows[c].cells;if(s.length>i){for(var p=o.cellIndex;0<=p;p--)1<s[p].rowSpan&&(s[p].rowSpan+=1);break}}q.cmd.range.selectNodeContents(o).collapse(!0),q.cmd.select(),q.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=q.plugin.getSelectedTable()[0],l=q.plugin.getSelectedRow()[0],t=q.plugin.getSelectedCell()[0],o=l.rowIndex+t.rowSpan,n=e.rows[o];if(!(e.rows.length<=o)){var a=t.cellIndex;if(!(n.cells.length<=a)){var i=n.cells[a];t.colSpan===i.colSpan&&(t.rowSpan+=i.rowSpan,n.deleteCell(a),q.cmd.range.selectNodeContents(t).collapse(!0),q.cmd.select(),q.addBookmark())}}},colmerge:function(){q.plugin.getSelectedTable()[0];var e=q.plugin.getSelectedRow()[0],l=q.plugin.getSelectedCell()[0],t=(e.rowIndex,l.cellIndex+1);if(!(e.cells.length<=t)){var o=e.cells[t];l.rowSpan===o.rowSpan&&(l.colSpan+=o.colSpan,e.deleteCell(t),q.cmd.range.selectNodeContents(l).collapse(!0),q.cmd.select(),q.addBookmark())}},rowsplit:function(){var e=q.plugin.getSelectedTable()[0],l=q.plugin.getSelectedRow()[0],t=q.plugin.getSelectedCell()[0],o=l.rowIndex;if(1!==t.rowSpan){for(var n=s(0,l,t),a=1,i=t.rowSpan;a<i;a++){var r=e.rows[o+a],d=r.insertCell(n);1<t.colSpan&&(d.colSpan=t.colSpan),d.innerHTML=$.IE?"":"<br />",n=s(0,r,d)}$(t).removeAttr("rowSpan"),q.cmd.range.selectNodeContents(t).collapse(!0),q.cmd.select(),q.addBookmark()}},colsplit:function(){q.plugin.getSelectedTable()[0];var e=q.plugin.getSelectedRow()[0],l=q.plugin.getSelectedCell()[0],t=l.cellIndex;if(1!==l.colSpan){for(var o=1,n=l.colSpan;o<n;o++){var a=e.insertCell(t+o);1<l.rowSpan&&(a.rowSpan=l.rowSpan),a.innerHTML=$.IE?"":"<br />"}$(l).removeAttr("colSpan"),q.cmd.range.selectNodeContents(l).collapse(!0),q.cmd.select(),q.addBookmark()}},coldelete:function(){for(var e=q.plugin.getSelectedTable()[0],l=q.plugin.getSelectedRow()[0],t=q.plugin.getSelectedCell()[0].cellIndex,o=0,n=e.rows.length;o<n;o++){var a=e.rows[o],i=a.cells[t];1<i.colSpan?(i.colSpan-=1,1===i.colSpan&&$(i).removeAttr("colSpan")):a.deleteCell(t),1<i.rowSpan&&(o+=i.rowSpan-1)}0===l.cells.length?(q.cmd.range.setStartBefore(e).collapse(!0),q.cmd.select(),$(e).remove()):q.cmd.selection(!0),q.addBookmark()},rowdelete:function(){for(var e=q.plugin.getSelectedTable()[0],l=q.plugin.getSelectedRow()[0],t=q.plugin.getSelectedCell()[0],o=l.rowIndex,n=t.rowSpan-1;0<=n;n--)e.deleteRow(o+n);0===e.rows.length?(q.cmd.range.setStartBefore(e).collapse(!0),q.cmd.select(),$(e).remove()):q.cmd.selection(!0),q.addBookmark()}},q.clickToolbar(i,q.plugin.table.prop)});