define(["jquery"],function(v){"use strict";var e,i={getSelectedIDS:function(){return v.fn.grid._methods._getSelectedIDS(this.settings)},setSelectMode:function(e){return v.fn.grid._methods._setSelectMode(e,this.settings)},getCheckData:function(){return v.fn.grid._methods._getCheckData(this.settings)},getTotal:function(){return this.settings.gridDataTotal},refresh:function(){v.fn.grid._methods._loadPage(this.settings)},clear:function(){v.fn.grid._methods._clearGrid(this.settings)},load:function(e){var a=this.settings;a.page=1,a.data={},v.fn.grid._methods._clearCheckData(a),"[object Object]"===Object.prototype.toString.call(e)&&(a.data=e),v.fn.grid._methods._loadPage(a)}};(e=function(e){var a=this,t=v.extend({autoLoad:!0,url:"",type:"get",data:"",gridDataTotal:0,checkbox:!1,checkboxField:"id",checkAll:!1,checkRange:"page",isPaging:!0,pageSizeDefault:15,pageSize:15,page:1,pages:1},e);return a.settings=t,a.settings.$grid=v(a),a.settings.id=v(a).attr("id"),a.settings._={checked:{},checkedData:[],unchecked:{},uncheckedData:[]},a.settings._checkAll=a.settings.checkAll,v.extend(a,i),v.fn.grid._methods._init(a.settings),a})._methods={_init:function(e){this._initGrid(e),e.autoLoad&&this._loadPage(e)},_initGrid:function(e){e.$grid.wrap('<div class="table-wrap data-clear"></div>'),e.checkbox&&this._initCheckbox(e),this._triggerTr(e)},_triggerTr:function(e){var t=e.$grid;t.on("click","tbody tr",function(){var e="tr-selected",a=v(this).hasClass(e);t.find("."+e).removeClass(e),a?v(this).removeClass(e):v(this).addClass(e)})},_draw:function(e){var a=e,t=e.gridData,i=t.length,n=e.columns?e.columns:[],c=e.$grid,d=v("<tbody></tbody>");if(i)for(var o=0;o<i;o++){var s=v("<tr></tr>");if(a.checkbox){var l=this._initRowCheck(t[o][a.checkboxField],e);s.append('<td class="td-checkbox"><span class="checkbox-inline"><input name="'+a.checkboxField+'" type="checkbox" value="'+t[o][a.checkboxField]+'" '+(l?"checked":"")+" /><i></i></span></td>")}for(var g=0,r=n.length;g<r;g++){var p=v("<td></td>"),h=n[g].class,u=n[g].hidden,f=n[g].render,k=t[o][n[g].data];k="[object String]"===Object.prototype.toString.call(k)?k.replace(/</gi,"&lt;").replace(/>/gi,"&gt;"):k,u&&p.css("display","none"),h&&p.addClass(h),f&&"[object Function]"===Object.prototype.toString.call(f)?(p.html(f(k,t[o],o+1,e)),s.append(p)):(k&&p.html(k),s.append(p))}d.append(s)}else d.append('<tr class="nodata"><td colspan="'+c.find("thead th").length+'">无数据</td></tr>');var _=c.find("tbody");_.length&&_.remove(),c.append(d),e.$gridBody=d,e.onDraw&&e.onDraw(e)},_handlePageNo:function(e,a){return a.gridDataTotal?(e<=0?1:e>a.pages&&a.pages)||e:1},_handleData:function(e){var a=e,t="[object Object]"===Object.prototype.toString.call(a.data)?a.data:{};t.page&&(v.isNumeric(t.page)&&(a.page=t.page),delete a.data.page),t.pageSize&&(v.isNumeric(t.pageSize)&&(a.pageSize=t.pageSize),delete a.data.pageSize),a.dataSend=v.extend(a.isPaging?{page:a.page,pageSize:a.pageSize}:{},a.data)},_handleSuccessData:function(e,a){var t=a,i={};t.gridData=e.data?e.data:[],t.gridDataTotal=e.total?e.total:0,t.pages=Math.ceil(t.gridDataTotal/t.pageSize),t.page=this._handlePageNo(t.page,a),t.pages=t.pages?t.pages:1,t.isPaging&&(1<t.page&&(i.page=t.page),t.pageSize!=t.pageSizeDefault&&(i.pageSize=t.pageSize)),v.extend(i,t.data),t.dataHash=i},_addLoading:function(e){var a=e.$grid.parent(),t=v('<div class="table-loading"><div class="table-mask"></div><span class="loading"><i class="icon-loading"></i></span></div>');a.append(t)},_delLoading:function(e){e.$grid.parent().find(".table-loading").remove()},_ajaxData:function(i,n){var c=this,d=i;d.ajax&&d.ajax.abort(),d.ajax=v.ajax({url:d.url,data:d.dataSend,type:d.type,cache:!1,dataType:"json",beforeSend:function(e){c._addLoading(d),d.onBeforeSend&&d.onBeforeSend(e)},success:function(e,a,t){c._delLoading(d);e="[object Object]"===Object.prototype.toString.call(e)?e:{};c._handleSuccessData(e,i),d.onSuccess&&d.onSuccess(d.dataHash,e,t),e.data&&"[object Array]"===Object.prototype.toString.call(e.data)&&n&&n(e),d.ajax=null},error:function(e,a){c._delLoading(d),"abort"!=e.statusText&&d.onError&&d.onError(e,a),d.ajax=null}})},_loadPage:function(a,e){var t=this,i=a;e&&(i.page=t._handlePageNo(e,i)),t._handleData(i),i.$grid.parent().removeClass("data-clear"),t._ajaxData(i,function(e){i.checkbox&&"page"==i.checkRange&&t._clearCheckData(i),t._draw(i),i.checkbox&&t._setPageCheck(a),i.isPaging&&(!i.initPagination&&t._initPagination(i),t._setPageInfo(i),t._setPageStatus(i))})},_initPagination:function(e){var i=this,n=e,a=v('div[data-grid="'+n.id+'"]');a.length||(a=v('<div data-grid="'+n.id+'" data-total data-go data-jump></div>'),n.$grid.after(a)),a.each(function(){var e=v(this),a=e.data(),t=['<div class="page-jump">','<input type="text"/>','<div class="page-jump-info">/<span></span></div>',null!=a.go?'<button type="button" class="btn default"><i class="icon-search icon-only"></i>Go</button>':"","</div>"],i=v(['<div class="table-page">','<div class="inner">',null!=a.total?'<div class="page-data-total"></div>':"",null!=a.info?'<div class="page-info"></div>':"",'<div class="paging">','<a href="javascript:void(0);" class="prev" title="上一页"><i class="fa fa-angle-left"></i></a>','<a href="javascript:void(0);" class="next" title="下一页"><i class="fa fa-angle-right"></i></a>',"</div>",""+(null!=a.jump?t.join(""):""),"</div>"].join(""));e.append(i)}),n.pageStatus={first:!1,last:!1},a.on("click",".first",function(){n.pageStatus.first||i._loadPage(n,1)}),a.on("click",".prev",function(){n.pageStatus.first||i._loadPage(n,n.page-1)}),a.on("click",".next",function(){n.pageStatus.last||i._loadPage(n,n.page+1)}),a.on("click",".last",function(){n.pageStatus.last||i._loadPage(n,n.pages)}),a.on("input keyup",".page-jump input",function(e){var a=v(this),t=a.val().replace(/[^0-9]/g,"").replace(/^0([0-9]*)/,"$1");a.val(t),13==e.keyCode&&t&&i._loadPage(n,t)}),a.on("click",".page-jump button",function(){var e=v(this).parent().find("input").val();i._loadPage(n,e||1)}),n.$pgs=a,n.initPagination=!0},_setPageInfo:function(e){var a=e.$pgs,t=e,i=t.page;a.find(".page-data-total").html(t.gridDataTotal+" 条"),a.find(".page-info").html(i+"/"+t.pages),a.find(".page-jump-info span").html(t.pages),a.find(".page-jump input").val(i||"").width(i?8*(""+i).length+20:30)},_setPageStatus:function(e){var a=e,t=a.page<=1,i=a.page>=a.pages,n=a.$pgs;n.find(".first").toggleClass("disabled",t),n.find(".prev").toggleClass("disabled",t),n.find(".next").toggleClass("disabled",i),n.find(".last").toggleClass("disabled",i),a.pageStatus={first:t,last:i}},_initRowCheck:function(e,a){var t=a,i=!1;return t.checkAll?t._.unchecked[e]||(i=!0):t._.checked[e]&&(i=!0),i},_setPageCheck:function(e){var a=e,t='input[name="'+a.checkboxField+'"]:not(:disabled)',i='input[name="'+a.checkboxField+'"]:not(:disabled):checked';v("#"+a.pageCheckID).prop("checked",a.$grid.find(t).length==a.$grid.find(i).length).removeAttr("disabled")},_clearCheckData:function(e){var a=e;a._.checked={},a._.checkedData=[],a._.unchecked={},a._.uncheckedData=[]},_initCheckbox:function(a){var n=this,c=a,t=c.$grid,e=v('<input type="checkbox" disabled title="全选/反选（当前页）"/>'),i=v('<th class="th-multiCheck"><span class="checkbox-inline"><i></i></span></th>'),d='input[name="'+c.checkboxField+'"]:not(:disabled)';i.find("span").prepend(e),t.find("thead tr").prepend(i),c.pageCheckID=c.id+"-page-checkall",(c.$pageCheck=e).attr("id",c.pageCheckID).on("click",function(){var e=v(this).prop("checked");t.find(d).prop("checked",!!e),c.gridData&&n._setPageCheckData(e,c.gridData,a),c.onCheck&&c.onCheck(n._getCheckData(c))}),t.on("click",d,function(e){n._setPageCheck(c),e.cancelBubble=!0,e.stopPropagation();var a=v(this),t=a.prop("checked"),i=a.closest("tr").index();n._setRowCheckData(t,i,c),c.onCheck&&c.onCheck(n._getCheckData(c))})},_setPageCheckData:function(e,a,t){for(var i=0,n=a.length;i<n;i++)this._setRowCheckData(e,i,t)},_setRowCheckData:function(e,a,t){var i=t,n=i._.checked,c=i._.unchecked,d=i.gridData[a],o=d[i.checkboxField];i.checkAll?(e&&c[o]&&delete c[o],e||c[o]||(c[o]=v.extend(!0,{},d))):(e&&!n[o]&&(n[o]=v.extend(!0,{},d)),!e&&n[o]&&delete n[o])},_getCheckData:function(e){var a=e,t=e._.checked,i=[],n=e._.unchecked,c=[];for(var d in t)i.push(t[d]);for(var o in n)c.push(n[o]);return{checkAll:a.checkAll,total:a.gridDataTotal,checked:i,unchecked:c}},_getSelectedIDS:function(e){var a=e,t=a.$grid.find('input[name="'+a.checkboxField+'"]:not(:disabled):checked'),i=[];return t.each(function(){i.push(v(this).val())}),i.join(",")},_setSelectMode:function(e,a){var t=a,i='input[name="'+t.checkboxField+'"]:not(:disabled)';t.checkAll!=e&&(t.checkAll=e,this._clearCheckData(t),t.$grid.find(i).prop("checked",e),v("#"+t.pageCheckID).prop("checked",e))},_clearGrid:function(e){var a=e;a.$grid.parent().addClass("data-clear"),a.$gridBody&&a.$gridBody.remove(),a.$pageCheck.prop("disabled",!0),a.$pgs&&a.$pgs.find(".table-page").remove(),a.initPagination=!1,a.page=1,a.pages=0}},e.version="1.0",v.fn.grid=e});