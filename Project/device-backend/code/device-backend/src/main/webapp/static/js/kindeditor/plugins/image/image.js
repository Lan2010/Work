KindEditor.plugin("image",function(S){var D=this,F="image",e=S.undef(D.allowImageUpload,!0),t=S.undef(D.allowImageRemote,!0),L=S.undef(D.formatUploadUrl,!0),W=S.undef(D.allowFileManager,!1),_=S.undef(D.uploadJson,D.basePath+"php/upload_json.php"),a=S.undef(D.imageTabIndex,0),P=D.pluginsPath+"image/images/",B=S.undef(D.extraFileUploadParams,{}),A=S.undef(D.filePostName,"imgFile"),H=S.undef(D.fillDescAfterUploadImage,!1),R=D.lang(F+".");D.plugin.imageDialog=function(e){e.imageUrl,S.undef(e.imageWidth,""),S.undef(e.imageHeight,""),S.undef(e.imageTitle,""),S.undef(e.imageAlign,"");var o=S.undef(e.showRemote,!0),d=S.undef(e.showLocal,!0),t=S.undef(e.tabIndex,0),r=e.clickFn,a="kindeditor_upload_iframe_"+(new Date).getTime(),i=[];for(var l in B)i.push('<input type="hidden" name="'+l+'" value="'+B[l]+'" />');var s,n=['<div style="padding:20px;">','<div class="tabs"></div>','<div class="tab1" style="display:none;">','<div class="ke-dialog-row">','<label for="remoteUrl" style="width:60px;">'+R.remoteUrl+"</label>",'<input type="text" id="remoteUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+R.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="remoteWidth" style="width:60px;">'+R.size+"</label>",R.width+' <input type="text" id="remoteWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> ',R.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> ','<img class="ke-refresh-btn" src="'+P+'refresh.png" width="16" height="16" alt="" style="cursor:pointer;" title="'+R.resetSize+'" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+R.align+"</label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+P+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+P+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+P+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="remoteTitle" style="width:60px;">'+R.imgTitle+"</label>",'<input type="text" id="remoteTitle" class="ke-input-text" name="title" value="" style="width:200px;" />',"</div>","</div>",'<div class="tab2" style="display:none;">','<iframe name="'+a+'" style="display:none;"></iframe>','<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+a+'" action="'+S.addParam(_,"dir=image")+'">','<div class="ke-dialog-row">',i.join(""),'<label style="width:60px;">'+R.localUrl+"</label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+R.upload+'" />',"</div>","</form>","</div>","</div>"].join(""),g=d||W?450:400,u=d&&o?300:250,c=D.createDialog({name:F,width:g,height:u,title:D.lang(F),body:n,yesBtn:{name:D.lang("yes"),click:function(e){if(!c.isLoading){if(d&&o&&s&&1===s.selectedIndex||!o)return""==x.fileBox.val()?void alert(D.lang("pleaseSelectFile")):(c.showLoading(D.lang("uploadLoading")),x.submit(),void p.val(""));var t=S.trim(h.val()),a=v.val(),i=b.val(),l=w.val(),n="";return y.each(function(){if(this.checked)return n=this.value,!1}),"http://"==t||S.invalidUrl(t)?(alert(D.lang("invalidUrl")),void h[0].focus()):/^\d*$/.test(a)?/^\d*$/.test(i)?void r.call(D,t,l,a,i,0,n):(alert(D.lang("invalidHeight")),void b[0].focus()):(alert(D.lang("invalidWidth")),void v[0].focus())}}},beforeRemove:function(){f.unbind(),v.unbind(),b.unbind(),k.unbind()}}),m=c.div,h=S('[name="url"]',m),p=S('[name="localUrl"]',m),f=S('[name="viewServer"]',m),v=S('.tab1 [name="width"]',m),b=S('.tab1 [name="height"]',m),k=S(".ke-refresh-btn",m),w=S('.tab1 [name="title"]',m),y=S('.tab1 [name="align"]',m);o&&d?((s=S.tabs({src:S(".tabs",m),afterSelect:function(e){}})).add({title:R.remoteImage,panel:S(".tab1",m)}),s.add({title:R.localImage,panel:S(".tab2",m)}),s.select(t)):o?S(".tab1",m).show():d&&S(".tab2",m).show();var x=S.uploadbutton({button:S(".ke-upload-button",m)[0],fieldName:A,form:S(".ke-form",m),target:a,width:60,afterUpload:function(e){if(c.hideLoading(),0===e.error){var t=e.url;L&&(t=S.formatUrl(t,"absolute")),D.afterUpload&&D.afterUpload.call(D,t,e,F),H?(S(".ke-dialog-row #remoteUrl",m).val(t),S(".ke-tabs-li",m)[0].click(),S(".ke-refresh-btn",m).click()):r.call(D,t,e.title,e.width,e.height,e.border,e.align)}else alert(e.message)},afterError:function(e){c.hideLoading(),D.errorDialog(e)}});x.fileBox.change(function(e){p.val(x.fileBox.val())}),W?f.click(function(e){D.loadPlugin("filemanager",function(){D.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(e,t){1<D.dialogs.length&&(S('[name="url"]',m).val(e),D.afterSelectFile&&D.afterSelectFile.call(D,e),D.hideDialog())}})})}):f.hide();var U=0,I=0;function T(e,t){v.val(e),b.val(t),U=e,I=t}return k.click(function(e){var t=S('<img src="'+h.val()+'" />',document).css({position:"absolute",visibility:"hidden",top:0,left:"-1000px"});t.bind("load",function(){T(t.width(),t.height()),t.remove()}),S(document.body).append(t)}),v.change(function(e){0<U&&b.val(Math.round(I/U*parseInt(this.value,10)))}),b.change(function(e){0<I&&v.val(Math.round(U/I*parseInt(this.value,10)))}),h.val(e.imageUrl),T(e.imageWidth,e.imageHeight),w.val(e.imageTitle),y.each(function(){if(this.value===e.imageAlign)return!(this.checked=!0)}),o&&0===t&&(h[0].focus(),h[0].select()),c},D.plugin.image={edit:function(){var o=D.plugin.getSelectedImage();D.plugin.imageDialog({imageUrl:o?o.attr("data-ke-src"):"http://",imageWidth:o?o.width():"",imageHeight:o?o.height():"",imageTitle:o?o.attr("title"):"",imageAlign:o?o.attr("align"):"",showRemote:t,showLocal:e,tabIndex:o?0:a,clickFn:function(e,t,a,i,l,n){o?(o.attr("src",e),o.attr("data-ke-src",e),o.attr("width",a),o.attr("height",i),o.attr("title",t),o.attr("align",n),o.attr("alt",t)):D.exec("insertimage",e,t,a,i,l,n),setTimeout(function(){D.hideDialog().focus()},0)}})},delete:function(){var e=D.plugin.getSelectedImage();"a"==e.parent().name&&(e=e.parent()),e.remove(),D.addBookmark()}},D.clickToolbar(F,D.plugin.image.edit)});