define(["jquery","Global","Menu","Validate","Grid","DTP"],function(c,o,n,e,t){"use strict";var a,s,d,r,i,l={},u=0,f=function(e){e?(l=e).checkTotal=e.checkAll?e.total-e.unchecked.length:e.checked.length:l.checkTotal=0,c("#selectedTotal").text(l.checkTotal),console.log(l)},h=function(){c("#tableCheckType").prop("disabled",!0),i.clear(),l={},f(0)},m=function(){var e,t,n;t=c("#devTable"),n="/api/firmware/queryDevList",i=t.grid({autoLoad:!1,url:o.path+n,data:e,pageSize:10,checkbox:!0,checkAll:!0,checkRange:"all",columns:[{data:"orderNo",class:"td-sn",render:function(e,t,n,a){return a.pageSize*(a.page-1)+n}},{data:"number"},{data:"model"},{data:"bind",render:function(e,t,n){return t.bindAccount?'<span title="绑定时间：'+c.date(t.bindTime).ymd+'">'+t.bindAccount+"</span>":"未绑定"}},{data:"isOnlined",class:"txt-c",render:function(e,t,n){return e?"是":"否"}},{data:"belongUnitId",render:function(e,t,n){return(1===e?"天智星":0===e&&"未知")||""}}],onCheck:function(e){f(e)},onSuccess:function(e,t){o.checkJson(t)&&(f(i.getCheckData()),c("#tableCheckType").removeAttr("disabled"))},onError:function(e,t){c("body").msg("error",{text:n+" - "+e.status+" - "+e.statusText+" - "+t})}}),c("#tableCheckType").on("click",function(){i.setSelectMode(c(this).prop("checked")),f(i.getCheckData())}),d.on("submit",function(){if(""==c("#firmwareNameId").val()||""==c("#version").val())return o.$page.msg({text:"请先选择更新的固件和版本",time:3e3}),!1;var e=d.packJson({nullVal:!1});return i.load(e),!1}),d.on("click","button[data-btn=clear]",function(){d.get(0).reset(),h()})},p=function(e){!function(){var e=o.path+"/api/firmware/firmwareNamelist",n=o.path+"/api/firmware/queryVersion";c("#firmwareNameId").setSelect({url:e,id:"firmwareNameId",name:"nickName",relate:["#version"],onChange:function(e,t){c("#s_firmwareNameId").val(e),h(),c("#version").setSelect({url:n,data:{firmwareNameId:e},id:"version",name:"version",onChange:function(e,t){c("#s_version").val(e),h()}})}});var t=o.path+"/api/device/modelList";c("#model").setSelect({url:t,id:"code",name:"name"})}(),c("#upgradeType").on("change",function(){var e=c(this).val();c("#append").toggleClass("hide",e),0==e&&s.find("input[name=append]").prop("checked",!0).eq(2).prop("checked",!1)}),c("#selectType").on("change","input",function(){var e=c(this).val();u=e,c("#taskDevInput").toggleClass("hide",1==e),c("#taskDev").toggleClass("hide",0==e)}),m(),a=s.validate(),g(),s.on("submit",function(){if(!a.form())return!1;var e=function(){if(0==u){var e=c("#devs").val();if(!e)return o.$page.msg({text:"请输入设备编号",time:3e3}),null;if(!/^([\r\n\s ,，]*[0-9a-z]{14}[\r\n\s ,，]*)([\r\n\s ,，]+[0-9a-z]{14}[\r\n\s ,，]*)*$/.test(e))return o.$page.msg({text:"设备编号格式有误",time:3e3}),null;var t=s.packJson();return e=e.replace(/[\r\n\s ,，]+/g,"\n").replace(/(^[\r\n\s ,，]+)|([\r\n\s ,，]+$)/,""),t.devNums=e.replace(/[\r\n\s ,，]+/g,","),t}if(1==u){if(!l.checkTotal)return o.$page.msg({text:"至少选择一台设备",time:3e3}),null;t=c.extend({},s.packJson(),d.packJson({nullVal:!1}));for(var n=[],a=l.checkAll?l.unchecked:l.checked,r=0,i=a.length;r<i;r++)n.push(a[r].id);return t.selectType=l.checkAll?1:0,t.devIds=n.join(","),t}return null}();if(!e)return!1;if(!confirm("确定提交任务？"))return!1;o.$page.msg("loading",{text:"添加中"});var n=1==u?"/api/firmware/addTaskBySearch":"/api/firmware/addTaskByDevids";return c.ajax({url:o.path+n,type:"post",data:e,dataType:"json",success:function(e){if(10201==e.code&&e.data)return o.$page.msg("hide"),void v(e.data);o.checkJson(e)&&(o.$page.msg("success",{text:"新建成功",time:3e3}),window.history.back())},error:function(e,t){o.$page.msg("error",{text:n+" - "+e.status+" - "+e.statusText+" - "+t})}}),!1}),c("#btnSubmit").on("click",function(){s.submit()})},g=function(){r.on("click",".close",function(){c(this).parent().addClass("hide").find("#notexist,#notmatch").addClass("hide").find("info").text("")})},v=function(e){var t=e.error_devnums,n=e.NoPath_devnums;t=t||[],n=n||[],r.removeClass("hide"),r.find("#notexist").toggleClass("hide",!t.length).find(".info").text(t.join(", ")),r.find("#notmatch").toggleClass("hide",!n.length).find(".info").text(n.join(", "))};return{onSearch:function(e,t){},onLoad:function(e,t){n.active("fmwTask/list"),o.$page.addClass("page-gray"),t,s=c("#formAdd"),d=c("#formSearch"),r=c("#taskError"),p()}}});