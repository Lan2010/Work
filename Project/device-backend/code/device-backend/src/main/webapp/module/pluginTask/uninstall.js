define(["jquery","Global","Menu","Validate","Grid","DTP"],function(r,o,n,e,t){"use strict";var a,s,l,i,c,d={},u=0,p=function(e){e?(d=e).checkTotal=e.checkAll?e.total-e.unchecked.length:e.checked.length:d.checkTotal=0,r("#selectedTotal").text(d.checkTotal),console.log(d)},h=function(){r("#tableCheckType").prop("disabled",!0),c.clear(),d={},p(0)},f=function(){var e,t,n;t=r("#devTable"),n="/api/ipk/queryDevList",c=t.grid({autoLoad:!1,url:o.path+n,data:e,pageSize:10,checkbox:!0,checkAll:!0,checkRange:"all",columns:[{data:"orderNo",class:"td-sn",render:function(e,t,n,a){return a.pageSize*(a.page-1)+n}},{data:"number"},{data:"model"},{data:"bind",render:function(e,t,n){return t.bindAccount?'<span title="绑定时间：'+r.date(t.bindTime).ymd+'">'+t.bindAccount+"</span>":"未绑定"}},{data:"isOnlined",class:"txt-c",render:function(e,t,n){return e?"是":"否"}},{data:"belongUnitId",render:function(e,t,n){return(1===e?"天智星":0===e&&"未知")||""}}],onCheck:function(e){p(e)},onSuccess:function(e,t){o.checkJson(t)&&(p(c.getCheckData()),r("#tableCheckType").removeAttr("disabled"))},onError:function(e,t){r("body").msg("error",{text:n+" - "+e.status+" - "+e.statusText+" - "+t})}}),r("#tableCheckType").on("click",function(){c.setSelectMode(r(this).prop("checked")),p(c.getCheckData())}),l.on("submit",function(){if(""==r("#ipkNameId").val()||""==r("#version").val())return o.$page.msg({text:"请先选择卸载的插件和版本",time:3e3}),!1;var e=l.packJson({nullVal:!1});return c.load(e),!1}),l.on("click","button[data-btn=clear]",function(){l.get(0).reset(),h()})},k=function(e){!function(){var e=o.path+"/api/ipk/ipkNamelist";o.path;r("#ipkNameId").setSelect({url:e,id:"ipkNameId",name:"ipkNickName",onChange:function(e,t){r("#s_ipkNameId").val(e),h()}});var t=o.path+"/api/device/modelList";r("#model").setSelect({url:t,id:"code",name:"name"})}(),r("#selectType").on("change","input",function(){var e=r(this).val();u=e,r("#taskDevInput").toggleClass("hide",1==e),r("#taskDev").toggleClass("hide",0==e)}),f(),a=s.validate(),g(),s.on("submit",function(){if(!a.form())return!1;var e=function(){if(0==u){var e=r("#devs").val();if(!e)return o.$page.msg({text:"请输入设备编号",time:3e3}),null;if(!/^([\r\n\s ,，]*[0-9a-z]{14}[\r\n\s ,，]*)([\r\n\s ,，]+[0-9a-z]{14}[\r\n\s ,，]*)*$/.test(e))return o.$page.msg({text:"设备编号格式有误",time:3e3}),null;var t=s.packJson();return e=e.replace(/[\r\n\s ,，]+/g,"\n").replace(/(^[\r\n\s ,，]+)|([\r\n\s ,，]+$)/,""),t.devNums=e.replace(/[\r\n\s ,，]+/g,","),t}if(1==u){if(!d.checkTotal)return o.$page.msg({text:"至少选择一台设备",time:3e3}),null;t=r.extend({},s.packJson(),l.packJson({nullVal:!1}));for(var n=[],a=d.checkAll?d.unchecked:d.checked,i=0,c=a.length;i<c;i++)n.push(a[i].id);return t.selectType=d.checkAll?1:0,t.devIds=n.join(","),t}return null}();if(!e)return!1;if(!confirm("确定提交任务？"))return!1;o.$page.msg("loading",{text:"添加中"});var n=1==u?"/api/ipk/addIpkTaskBySearch":"/api/ipk/addIpkTaskByDevids";return r.ajax({url:o.path+n,type:"post",data:e,dataType:"json",success:function(e){if(10201==e.code&&e.data)return o.$page.msg("hide"),void m(e.data);o.checkJson(e)&&(o.$page.msg("success",{text:"新建成功",time:3e3}),window.history.back())},error:function(e,t){o.$page.msg("error",{text:n+" - "+e.status+" - "+e.statusText+" - "+t})}}),!1}),r("#btnSubmit").on("click",function(){s.submit()})},g=function(){i.on("click",".close",function(){r(this).parent().addClass("hide").find("#notexist,#notmatch").addClass("hide").find("info").text("")})},m=function(e){var t=e.error_devnums,n=e.NoPath_devnums;t=t||[],n=n||[],i.removeClass("hide"),i.find("#notexist").toggleClass("hide",!t.length).find(".info").text(t.join(", ")),i.find("#notmatch").toggleClass("hide",!n.length).find(".info").text(n.join(", "))};return{onSearch:function(e,t){},onLoad:function(e,t){n.active("pluginTask/list"),o.$page.addClass("page-gray"),t,s=r("#formAdd"),l=r("#formSearch"),i=r("#taskError"),k()}}});