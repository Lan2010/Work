define(["jquery","Global","Menu","Validate","Grid","DTP"],function(s,o,n,e,t){"use strict";var a,l,d,c,i,u={},h=0,r=function(e){e?(u=e).checkTotal=e.checkAll?e.total-e.unchecked.length:e.checked.length:u.checkTotal=0,s("#selectedTotal").text(u.checkTotal),console.log(u)},p=function(){var e,t,n;t=s("#devTable"),n="/api/device/list",i=t.grid({autoLoad:!1,url:o.path+n,data:e,pageSize:10,checkbox:!0,checkAll:!0,checkRange:"all",columns:[{data:"orderNo",class:"td-sn",render:function(e,t,n,a){return a.pageSize*(a.page-1)+n}},{data:"number"},{data:"model"},{data:"bind",render:function(e,t,n){return t.bindAccount?'<span title="绑定时间：'+s.date(t.bindTime).ymd+'">'+t.bindAccount+"</span>":"未绑定"}},{data:"isOnlined",class:"txt-c",render:function(e,t,n){return e?"是":"否"}},{data:"belongUnitId",render:function(e,t,n){return(1===e?"天智星":0===e&&"未知")||""}}],onCheck:function(e){r(e)},onSuccess:function(e,t){o.checkJson(t)&&(r(i.getCheckData()),s("#tableCheckType").removeAttr("disabled"))},onError:function(e,t){s("body").msg("error",{text:n+" - "+e.status+" - "+e.statusText+" - "+t})}}),s("#tableCheckType").on("click",function(){i.setSelectMode(s(this).prop("checked")),r(i.getCheckData())}),d.on("submit",function(){var e=d.packJson({nullVal:!1});return i.load(e),!1}),d.on("click","button[data-btn=clear]",function(){d.get(0).reset(),s("#tableCheckType").prop("disabled",!0),i.clear(),u={},r(0)})},f=function(e){!function(){var e=o.path+"/api/shell/shellNamelist";s("#shellId").setSelect({url:e,id:"shellId",name:"shellName"});var t=o.path+"/api/device/modelList";s("#model").setSelect({url:t,id:"code",name:"name"})}(),s("#upgradeType").on("change",function(){var e=s(this).val();s("#append").toggleClass("hide",e),0==e&&l.find("input[name=append]").prop("checked",!0).eq(2).prop("checked",!1)}),s("#selectType").on("change","input",function(){var e=s(this).val();h=e,s("#taskDevInput").toggleClass("hide",1==e),s("#taskDev").toggleClass("hide",0==e)}),p(),a=l.validate(),g(),l.on("submit",function(){if(!a.form())return!1;var e=function(){var e=null;if(0==h){var t=s("#devs").val();if(!t)return o.$page.msg({text:"请输入设备编号",time:3e3}),e;if(!/^([\r\n\s ,，]*[0-9a-z]{14}[\r\n\s ,，]*)([\r\n\s ,，]+[0-9a-z]{14}[\r\n\s ,，]*)*$/.test(t))return o.$page.msg({text:"设备编号格式有误",time:3e3}),e;var n=l.packJson();return t=t.replace(/[\r\n\s ,，]+/g,"\n").replace(/(^[\r\n\s ,，]+)|([\r\n\s ,，]+$)/,""),n.devNums=t.replace(/[\r\n\s ,，]+/g,","),n}if(1==h){if(!u.checkTotal)return o.$page.msg({text:"至少选择一台设备",time:3e3}),e;n=s.extend({},l.packJson(),d.packJson({nullVal:!1}));for(var a=[],c=u.checkAll?u.unchecked:u.checked,i=0,r=c.length;i<r;i++)a.push(c[i].id);return n.selectType=u.checkAll?1:0,n.devIds=a.join(","),n}return e}();if(!e)return!1;if(!confirm("确定提交任务？"))return!1;o.$page.msg("loading",{text:"添加中"});var n=1==h?"/api/shell/addTaskBySearch":"/api/shell/addTaskByDevids";return s.ajax({url:o.path+n,type:"post",data:e,dataType:"json",success:function(e){if(10201==e.code&&e.data)return o.$page.msg("hide"),void k(e.data);o.checkJson(e)&&(o.$page.msg("success",{text:"新建成功",time:3e3}),window.history.back())},error:function(e,t){o.$page.msg("error",{text:n+" - "+e.status+" - "+e.statusText+" - "+t})}}),!1}),s("#btnSubmit").on("click",function(){l.submit()})},g=function(){c.on("click",".close",function(){s(this).parent().addClass("hide").find("#notexist,#notmatch").addClass("hide").find("info").text("")})},k=function(e){var t=e.error_devnums,n=e.NoPath_devnums;t=t||[],n=n||[],c.removeClass("hide"),c.find("#notexist").toggleClass("hide",!t.length).find(".info").text(t.join(", ")),c.find("#notmatch").toggleClass("hide",!n.length).find(".info").text(n.join(", "))};return{onSearch:function(e,t){},onLoad:function(e,t){n.active("shellTask/list"),o.$page.addClass("page-gray"),t,l=s("#formAdd"),d=s("#formSearch"),c=s("#taskError"),f()}}});